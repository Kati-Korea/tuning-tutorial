<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>초보자를 위한 밸브 컨트롤 배기 | 조율 가능한 사운드와 퍼포먼스 가이드</title>
  <style>
    :root { --bg:#ffffff; --text:#222; --muted:#666; --primary:#0c6efd; --accent:#f0f4ff; --card:#fafafa; --border:#e5e7eb; --caption-bg:#f8fafc; --caption-text:#6b7280; --ad-bg:#d8d8d8; }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,"Apple SD Gothic Neo","Malgun Gothic","맑은 고딕",sans-serif;background:var(--bg);color:var(--text);line-height:1.65}
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1040px;margin:0 auto;padding:24px}
    .partner-inner{max-width:1040px;margin:0 auto;padding:10px 24px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;justify-content:center;text-align:center}
    .partner{display:flex;align-items:center;gap:6px}
    .partner img{height:28px;width:auto;object-fit:contain;display:block}
    .partner .text-box{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:28px}
    .partner .name{font-size:13px;font-weight:600;color:var(--text);margin:0}
    .partner .url{font-size:11px;color:var(--muted);margin:0}
    header .brand{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:center;text-align:center;width:100%}
    header .brand h1{width:100%;margin:0;font-size:20px;font-weight:700}
    .grid{display:grid;grid-template-columns:1.2fr 2fr;gap:24px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .toc{position:sticky;top:12px;align-self:start;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
    .toc h3{margin:0 0 12px;font-size:16px;border-bottom:1px dashed var(--border);padding-bottom:8px;text-align:center}
    .toc ol{margin:0;padding-left:16px;font-size:13px;line-height:1.5}
    .toc li{margin:4px 0}
    .back{display:block;width:100%;text-align:center;padding:8px 12px;border-radius:8px;background:#eef2ff;border:1px solid var(--border);color:#1f2937;font-size:14px;font-weight:600;margin-bottom:12px;text-decoration:none}
    .back:hover{filter:brightness(1.03);text-decoration:none}
    .banner-stack{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .banner{display:grid;grid-template-columns:88px 1fr;gap:10px;width:100%;background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;text-decoration:none;transition:box-shadow .2s ease,transform .2s ease;align-items:center}
    .banner:hover{box-shadow:0 4px 14px rgba(0,0,0,0.08);transform:translateY(-1px)}
    .banner .content .title{margin:0;font-size:14px;color:var(--text);font-weight:600}
    .banner .content .desc{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .section{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:18px;position:relative}
    .section h3{margin:0 0 8px;font-size:18px}
    .section .subtitle{color:var(--muted);margin-bottom:12px;font-size:14px}
    .callout{background:var(--accent);border-left:4px solid var(--primary);padding:10px 12px;border-radius:6px;margin:10px 0;font-size:14px}
    .footer{margin-top:16px;padding:16px 0 40px;color:var(--muted);font-size:13px;border-top:1px solid var(--border)}
    .tag{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted);margin-right:6px}
    figure.img-card{margin:8px auto 12px;padding:8px;border:1px solid var(--border);border-radius:10px;background:#fff;width:fit-content}
    .img-376,.img-576,.img-vid,.img-ad{overflow:hidden;border-radius:6px}
    .img-376{width:376px;height:376px}
    .img-576{width:576px;height:576px}
    .img-vid{width:376px;height:211px}
    .img-ad{width:576px;height:776px;border-radius:8px}
    .img-376>img,.img-576>img,.img-vid>img,.img-ad>img{width:100%;height:100%;object-fit:cover;object-position:center;display:block}
    figcaption.credit{margin-top:6px;padding:6px 8px;background:var(--caption-bg);color:var(--caption-text);border:1px dashed var(--border);border-radius:6px;font-size:12px;line-height:1.4}
    figcaption.credit a{color:inherit;text-decoration:underline;text-underline-offset:2px}
    .center{text-align:center}
    .center-inline{display:inline-block}
    .video-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .video-overlay.active{display:flex}
    .video-modal{position:relative;background:#000;border-radius:10px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.35);width:min(90vw,1280px);height:min(80vh,720px)}
    .video-modal iframe{width:100%;height:100%;display:block;border:0}
    .video-close{position:absolute;top:8px;right:8px;background:rgba(255,255,255,0.9);color:#111;border:none;border-radius:999px;width:32px;height:32px;font-size:18px;cursor:pointer;line-height:32px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.2)}
    .video-close:hover{background:#fff}
    .video-thumb{cursor:pointer}
    .ad-section{background:var(--ad-bg);border-color:#cfcfcf}
    .ad-card{display:inline-block;padding:10px;border-radius:10px;background:#fff;border:1px solid var(--border)}
    .ad-link{display:inline-block;margin-top:6px;font-size:12px;color:var(--muted)}
    .video-error {
      position:fixed; left:50%; top:16px; transform:translateX(-50%);
      background:#fee2e2; color:#991b1b; border:1px solid #fecaca; border-radius:8px;
      padding:8px 12px; font-size:12px; display:none; z-index:1100;
      box-shadow:0 6px 16px rgba(0,0,0,0.15);
    }
    .video-error a { color:#991b1b; text-decoration:underline; }
  </style>
  <link rel="icon" href="/logo_Icon.ico">
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>초보자를 위한 밸브 컨트롤 배기 · 조율 가능한 사운드 & 퍼포먼스</h1>
        <span class="tag">입문용</span>
        <span class="tag">한국 기준</span>
      </div>
      <div class="partner-inner">
        <a class="partner" href="http://www.katiagroup.or.kr/" target="_blank" rel="noopener" aria-label="KATIA">
          <img src="../image/logo_new.png" alt="KATIA 로고">
          <div class="text-box">
            <div class="name">Korea Auto Tuning Industry Association</div>
            <div class="url">www.katiagroup.or.kr</div>
          </div>
        </a>
        <a class="partner" href="http://www.kal.ac.kr" target="_blank" rel="noopener" aria-label="KAL">
          <img src="../image/kal_logo.png" alt="KAL 로고">
          <div class="text-box">
            <div class="name">KAL</div>
            <div class="url">www.kal.ac.kr</div>
          </div>
        </a>
      </div>
    </header>

    <div class="grid">
      <nav class="toc">
        <a class="back" href="../menu03.html" aria-label="이전 페이지로">← 이전 페이지</a>
        <h3>초보자를 위한 밸브 컨트롤 배기<br>사운드·퍼포먼스 가이드</h3>
        <h3>▣ 목 차 ▣</h3>
        <ol>
          <li><a href="#cover">표지</a></li>
          <li><a href="#intro">왜 밸브 컨트롤 배기인가</a></li>
          <li><a href="#system">시스템 개요: 구성·작동·KPI</a></li>
          <li><a href="#theory">유동·음향 이론</a></li>
          <li><a href="#hardware">하드웨어 심화</a></li>
          <li><a href="#control">제어 아키텍처</a></li>
          <li><a href="#design">설계·사전검토</a></li>
          <li><a href="#sop">장착 SOP</a></li>
          <li><a href="#calibration">캘리브레이션/검수</a></li>
          <li><a href="#maintenance">유지관리/내구</a></li>
          <li><a href="#advanced">고급 토픽</a></li>
          <li><a href="#troubleshoot">트러블슈팅</a></li>
          <li><a href="#cost">비용/패키지</a></li>
          <li><a href="#law">법령·검사·단속·보험</a></li>
          <li><a href="#ncs">NCS 기반 직무역량·평가</a></li>
          <li><a href="#labs">실습 시나리오</a></li>
          <li><a href="#communication">고객 커뮤니케이션</a></li>
          <li><a href="#appendix">부록 A~C</a></li>
        </ol>

        <div class="banner-stack" aria-label="권장 링크 배너">
          <a class="banner" href="https://www.google.com/search?q=valved+muffler+cutaway" target="_blank" rel="noopener">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b0/Muffler_cross_section.jpg/320px-Muffler_cross_section.jpg" style="width:80px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border);display:block" alt="머플러 단면">
            <div class="content">
              <p class="title">머플러 구조</p>
              <p class="desc">레조넌스·흡음 이해</p>
            </div>
          </a>
          <a class="banner" href="https://www.google.com/search?q=active+exhaust+valve+actuator" target="_blank" rel="noopener">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Exhaust_valve_actuator.jpg/320px-Exhaust_valve_actuator.jpg" style="width:80px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border);display:block" alt="액추에이터">
            <div class="content">
              <p class="title">액추에이터</p>
              <p class="desc">진공/전동 비교</p>
            </div>
          </a>
          <a class="banner" href="https://main.kotsa.or.kr/main.do" target="_blank" rel="noopener">
            <img src="https://main.kotsa.or.kr/web/images/common/logo.svg" style="width:80px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border);display:block" alt="TS">
            <div class="content">
              <p class="title">구조변경·검사</p>
              <p class="desc">TS 한국교통안전공단</p>
            </div>
          </a>
        </div>
      </nav>

      <main>
        <section id="cover" class="section">
          <div class="center">
            <figure class="img-card center-inline">
              <div class="img-576">
                <img src="https://images.unsplash.com/photo-1542362567-b07e54358753?q=80&w=1200&auto=format&fit=crop" alt="밸브 컨트롤 배기 컨셉 이미지">
              </div>
               <div class="ad-link">표지 · 출처: Unsplash</div>
            </figure>
          </div>
        </section>

        <section id="intro" class="section" data-index="1">
          <h3>01. 왜 밸브 컨트롤 배기인가</h3>
          <div class="subtitle">정숙과 퍼포먼스의 양립</div>
          <ul>
            <li>도심·저부하에서는 정숙, 고부하·트랙에서는 배압 저감으로 응답/출력 확보</li>
            <li>밸브 개폐 로직·유로 설계·법규 대응의 균형이 핵심</li>
            <li>드론 저감과 사운드 튜닝을 동시에 달성하는 솔루션</li>
          </ul>
        </section>

        <section id="system" class="section" data-index="2">
          <h3>02. 시스템 개요: 구성·작동·KPI</h3>
          <ul>
            <li><strong>구성품</strong>: 머플러(메인/바이패스), 밸브(버터플라이/게이트), 액추에이터(진공/전동), 센서(압력·온도·포지션), 하네스/리모컨·앱, 히트쉴드/브라켓</li>
            <li><strong>작동</strong>: 밸브 OFF(정숙/배압↑/드론↓), 밸브 ON(바이패스/배압↓/사운드↑/응답↑)</li>
            <li><strong>KPI</strong>: 배압[kPa], 소음[dB(A)], 드론 주파수[Hz], 열부하[°C], 내구[사이클], 전류/진공 요구치</li>
          </ul>
          <div class="center">
            <figure class="img-card center-inline">
              <div class="img-376">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Exhaust_system_components.png/512px-Exhaust_system_components.png" alt="배기 시스템 구성">
              </div>
              <div class="ad-link">배기 시스템 구성 · 출처: Wikimedia</div>
            </figure>
          </div>
        </section>

        <section id="theory" class="section" data-index="3">
          <h3>03. 유동·음향 이론</h3>
          <ul>
            <li><strong>배압과 출력</strong>: 터보는 터빈 전·후 배압 밸런스, NA는 스캐빈징/펄스 위상 최적화</li>
            <li><strong>음향</strong>: 헬름홀츠·쿼터웨이브 공명기로 드론(120–200 Hz 빈발) 억제</li>
            <li><strong>흡음재</strong>: 글라스울/바잘트의 내열·흡음 특성 이해</li>
          </ul>
          <div class="center">
            <figure class="img-card center-inline">
              <div class="img-376">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0b/Helmholtz_resonator.svg/512px-Helmholtz_resonator.svg.png" alt="헬름홀츠 공명 개념도">
              </div>
              <div class="ad-link">헬름홀츠 공명 · 출처: Wikimedia</div>
            </figure>
          </div>
        </section>

        <section id="hardware" class="section" data-index="4">
          <h3>04. 하드웨어 심화</h3>
          <ul>
            <li><strong>밸브</strong>: 버터플라이(단순·응답 빠름), 게이트(대유량·내열)</li>
            <li><strong>액추에이터</strong>: 진공식(빠른 응답·단순), 전동식(포지션 제어·CAN/LIN 연동)</li>
            <li><strong>재료/제작</strong>: SUS304/316, 인코넬, 티타늄, TIG 용접·백가스, 지그로 열변형 관리</li>
          </ul>
          <div class="center">
            <figure class="img-card center-inline">
              <div class="img-376">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/TIG_welding_stainless_steel.jpg/512px-TIG_welding_stainless_steel.jpg" alt="스테인리스 TIG 용접">
              </div>
              <div class="ad-link">TIG 용접 · 출처: Wikimedia</div>
            </figure>
          </div>
        </section>

        <section id="control" class="section" data-index="5">
          <h3>05. 제어 아키텍처</h3>
          <ul>
            <li><strong>입력</strong>: RPM, 스로틀, 기어/속도, 배압/온도, 드라이브 모드</li>
            <li><strong>출력/로직</strong>: 밸브 PWM/스텝, 히스테리시스, 과열시 페일세이프</li>
            <li><strong>인터페이스</strong>: RF 리모컨, 블루투스 앱, ECU CAN/LIN 게이트웨이</li>
            <li><strong>안전</strong>: 전원 상실 정책(폐쇄/개방), DTC/이상전류 진단</li>
          </ul>
        </section>

        <section id="design" class="section" data-index="6">
          <h3>06. 설계·사전검토</h3>
          <ul>
            <li>패키징: 차대/언더커버 간섭, 지상고·승하차 각도</li>
            <li>열: 히트쉴드, 연료/브레이크/전장 이격</li>
            <li>NVH: 브라켓 고유진동, 플렉스 파이프, 고무부시 적용</li>
            <li>센서: O2/온도 센서 위치, OPF/GPF·촉매 보호</li>
          </ul>
        </section>

        <section id="sop" class="section" data-index="7">
          <h3>07. 장착 SOP</h3>
          <ol>
            <li>안전: 차체 고정·배터리 분리·배기 온도 냉각</li>
            <li>순정 탈거: 센서 분리 토크 기록, 플랜지/부싱 점검</li>
            <li>지그/정렬: 팁 위치 기준, 차체 기준선 계측</li>
            <li>용접/체결: 백가스 TIG, 플랜지 평행도, 밴드클램프 토크</li>
            <li>액추에터/배선: 진공라인/체크밸브, 전동 하네스 방열/슬리브</li>
            <li>누설·간섭: 연막/압력 테스트, 풀바운스/롤링 간섭 확인</li>
            <li>시운전: 개폐 응답, 드론/진동, 열안정 후 리타이트</li>
          </ol>
          <div class="center">
            <figure class="img-card center-inline">
              <div class="img-vid video-thumb" data-video-id="x3a3G4mNru0" role="button" aria-label="액티브 배기 설치 영상 재생">
                <img src="https://i.ytimg.com/vi/x3a3G4mNru0/hqdefault.jpg" alt="액티브 배기 설치 썸네일">
              </div>
               <div class="ad-link">설치 예시 · 출처: YouTube</div>
            </figure>
          </div>
        </section>

        <section id="calibration" class="section" data-index="8">
          <h3>08. 캘리브레이션/검수</h3>
          <ul>
            <li>밸브 포지션 캘리브레이션, 부하/속도 기반 PWM 맵, 히스테리시스 설정</li>
            <li>계측: 배압 탭, 소음계 dB(A)·주파수 분석, 열화상</li>
            <li>목표: 드론 구간 dB 저감, 배압 변화율, 팁 센터·간격 유지, 누설 0</li>
            <li>문서화: 전/후 배압·소음 로그, 용접부 사진, 토크 시트, 회로도</li>
          </ul>
        </section>

        <section id="maintenance" class="section" data-index="9">
          <h3>09. 유지관리/내구</h3>
          <ul>
            <li>밸브 축/베어링 윤활, 카본 제거 주기</li>
            <li>진공 호스 경년변화 점검, 전동 액추에이터 방열 경로·포지션 센서 마모</li>
            <li>내식: 염분 환경 방청, 이종금속 접합 부식 방지</li>
          </ul>
        </section>

        <section id="advanced" class="section" data-index="10">
          <h3>10. 고급 토픽</h3>
          <ul>
            <li>터보: 개방 시 터빈 후단 저압화와 부스트 제어 맵 영향</li>
            <li>OPF/GPF·촉매: 후단에서만 바이패스 작동하도록 설계</li>
            <li>트랙 모드: 연속 고부하 열화/균열 방지, 팁 열변색 관리</li>
          </ul>
        </section>

        <section id="troubleshoot" class="section" data-index="11">
          <h3>11. 트러블슈팅</h3>
          <ul>
            <li>드론: 팁 길이/각도, 헬름홀츠 용량 보정, 리어 범퍼 공진 해결</li>
            <li>누기: 플랜지 변형/가스켓 재선정, 밴드클램프 재토크</li>
            <li>밸브 고착: 카본/과열 → 청소·부품 교환</li>
            <li>DTC: O2/배압 이상, CAN 불량 → 배선·차폐 점검</li>
          </ul>
        </section>

        <section id="cost" class="section" data-index="12">
          <h3>12. 비용/패키지</h3>
          <ul>
            <li>부품 등급: SUS304 밸브드 머플러(중가), 인코넬/티타늄(고가·경량)</li>
            <li>액추에이터: 진공형(가성비) vs 전동형(정밀 제어)</li>
            <li>공임: 차종·용접 난도·배선·앱 연동에 따라 편차 큼</li>
            <li>옵션: 팁 가변, 레조네이터 추가, 히트쉴드 커스텀</li>
          </ul>
        </section>

        <section id="law" class="section" data-index="13">
          <h3>13. 법령·검사·단속·보험(한국)</h3>
          <ul>
            <li><strong>구조변경</strong>: 배기계 개조는 원칙적으로 승인 대상. 가변 밸브 추가·직경/형상 변경은 경미한 튜닝 아님</li>
            <li><strong>배출가스</strong>: 촉매/OPF/GPF 제거·우회 불법, 제어장치 훼손 금지</li>
            <li><strong>소음</strong>: 가속/정지소음 기준 준수, 최신 고시·측정법 확인</li>
            <li><strong>안전</strong>: 배기 열/연료·브레이크·전장 이격, 히트쉴드 적용</li>
            <li><strong>보험</strong>: 개조 사실 고지·문서화, 사고 대비 책임 범위 확인</li>
          </ul>
          <div class="callout">참고: TS 한국교통안전공단 구조변경 가이드, 소음·배출가스 관련 법규를 시공 전 반드시 확인하세요.</div>
        </section>

        <section id="ncs" class="section" data-index="14">
          <h3>14. NCS 기반 직무역량·평가</h3>
          <ul>
            <li>요구분석/설계: 패키징·열/진동·법규 검토</li>
            <li>제작/시공: 용접 품질, 누설/정렬, 배선/방열</li>
            <li>제어/검수: 밸브 맵·배압/소음 계측, 문서화</li>
            <li>고객 인도: 운용/보증/점검 주기 안내</li>
          </ul>
          <ul>
            <li>누설 0, 플랜지 평행/팁 센터 합격</li>
            <li>드론 구간 dB 저감 목표 달성</li>
            <li>문서 패키지 100%(회로·토크·사진·로그)</li>
          </ul>
        </section>

        <section id="labs" class="section" data-index="15">
          <h3>15. 실습 시나리오(예시)</h3>
          <ul>
            <li>실습 A: 밸브드 머플러 용접/장착(지그·백가스 TIG)</li>
            <li>실습 B: 진공식 액추에터 배선/솔레노이드/체크밸브 세팅</li>
            <li>실습 C: 전동식 밸브 CAN/LIN 인터페이스 구성</li>
            <li>실습 D: 배압·소음·주파수 계측·드론 저감 튜닝</li>
            <li>실습 E: 법규 대응 문서 패키지 작성</li>
          </ul>
        </section>

        <section id="communication" class="section" data-index="16">
          <h3>16. 고객 커뮤니케이션</h3>
          <ul>
            <li><strong>인수설명서</strong>: 개폐 로직, 드라이브 모드 연동, 주의사항</li>
            <li><strong>운용 가이드</strong>: 예열/열안정, 주행 조건별 모드 권장</li>
            <li><strong>보증</strong>: 소모/내열·부식, 점검 주기, 책임 범위</li>
            <li><strong>문서</strong>: 회로도, 용접부 사진, 소음/배압 로그, 구조변경 서류</li>
          </ul>
        </section>

        <section id="appendix" class="section" data-index="17">
          <h3>17. 부록 A ~ C</h3>
          <ul>
            <li><strong>부록 A</strong> 체크리스트/로그/양식: 용접/토크/누설, 배선/퓨즈, 소음/배압 기록지</li>
            <li><strong>부록 B</strong> 권장 사양/부품·공구·내식: 재료 선택, 히트쉴드, 방청</li>
            <li><strong>부록 C</strong> 용어집·FAQ: 배압, 드론, 헬름홀츠, PWM, CAN/LIN 등</li>
          </ul>
        </section>

        <section class="section ad-section">
          <div class="center">
            <div class="ad-card">
              <a href="https://www.google.com/search?q=valved+exhaust+kit" target="_blank" rel="noopener" aria-label="밸브드 배기 키트 검색">
                <div class="img-ad">
                  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/67/Exhaust_muffler.jpg/512px-Exhaust_muffler.jpg" alt="머플러 이미지">
                </div>
              </a>
              <div class="ad-link">밸브드 머플러 키트 · 출처: Wikimedia</div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <div class="footer">
      <div class="center">실제 작업 시 차량 서비스 매뉴얼과 국내 법규(구조변경·소음·배출가스)를 반드시 확인하세요.</div>
    </div>
  </div>

  <div class="video-error" id="videoError" role="alert" aria-live="polite">
    동영상 임베드가 제한되어 재생할 수 없습니다. 아래 링크로 YouTube에서 직접 보세요.
    <a id="videoOpenLink" href="#" target="_blank" rel="noopener">YouTube에서 열기</a>
  </div>

  <div class="video-overlay" id="videoOverlay" aria-hidden="true">
    <div class="video-modal" role="dialog" aria-modal="true" aria-label="영상 재생">
      <button class="video-close" id="videoClose" aria-label="닫기">✕</button>
      <iframe id="videoFrame"
              src=""
              title="YouTube video player"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
              allowfullscreen>
      </iframe>
    </div>
  </div>

  <script>
    function buildEmbedUrl(videoId, startSec, useNoCookie, autoplay = true, muted = true, controls = 1, playsinline = 1) {
      if (!videoId) return null;
      const base = useNoCookie ? 'https://www.youtube-nocookie.com' : 'https://www.youtube.com';
      const params = new URLSearchParams({
        rel: '0',
        modestbranding: '1',
        playsinline: String(playsinline),
        controls: String(controls),
        enablejsapi: '1',
        origin: window.location.origin,
      });
      if (autoplay) params.set('autoplay', '1');
      if (muted) params.set('mute', '1');
      if (startSec) {
        const s = String(startSec).replace('s','');
        if (/^\d+$/.test(s)) params.set('start', s);
      }
      return `${base}/embed/${videoId}?${params.toString()}`;
    }

    function extractVideoId(raw) {
      if (!raw) return null;
      if (/^[A-Za-z0-9_-]{6,}$/.test(raw) && !raw.includes('http')) return raw;
      try {
        const url = new URL(raw);
        const host = url.hostname.replace('www.', '');
        if (host.includes('youtu.be')) return url.pathname.slice(1);
        if (host.includes('youtube')) {
          if (url.pathname === '/watch') return url.searchParams.get('v');
          if (url.pathname.startsWith('/shorts/')) return url.pathname.split('/')[2];
          if (url.pathname.startsWith('/embed/')) return url.pathname.split('/')[2];
        }
      } catch(e) {
        const m = String(raw).match(/(?:youtu\.be\/|v=|\/shorts\/|\/embed\/)([A-Za-z0-9_-]{6,})/);
        if (m) return m[1];
      }
      return null;
    }

    const overlay = document.getElementById('videoOverlay');
    const frame = document.getElementById('videoFrame');
    const btnClose = document.getElementById('videoClose');
    const errorBanner = document.getElementById('videoError');
    const openLink = document.getElementById('videoOpenLink');

    let lastVideoId = null;
    let lastStart = null;
    let lastOriginalUrl = null;
    let useNoCookieGlobal = false;
    let player = null;
    let lastFocused = null;

    function showError(originalUrl) {
      if (!errorBanner) return;
      openLink.href = originalUrl || (lastVideoId ? `https://www.youtube.com/watch?v=${lastVideoId}` : '#');
      errorBanner.style.display = 'block';
      clearTimeout(showError._t);
      showError._t = setTimeout(() => { errorBanner.style.display = 'none'; }, 8000);
    }

    function trapFocus(e) {
      if (!overlay.classList.contains('active')) return;
      const focusable = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (e.key === 'Tab') {
        if (e.shiftKey) {
          if (document.activeElement === first) {
            e.preventDefault();
            last.focus();
          }
        } else {
          if (document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }
    }

    function openOverlay() {
      lastFocused = document.activeElement;
      overlay.classList.add('active');
      overlay.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      btnClose.focus();
      document.addEventListener('keydown', trapFocus);
    }

    function closeOverlay() {
      overlay.classList.remove('active');
      overlay.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      document.removeEventListener('keydown', trapFocus);
      try { if (player && player.destroy) player.destroy(); } catch(e){}
      player = null;
      frame.src = '';
      if (lastFocused && lastFocused.focus) lastFocused.focus();
    }

    let YTReady = false;
    let YTLoading = false;
    const onYouTubeIframeAPIReadyCallbacks = [];
    function loadYouTubeAPI() {
      if (YTReady || YTLoading) return;
      YTLoading = true;
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      tag.async = true;
      document.head.appendChild(tag);
      window.onYouTubeIframeAPIReady = function() {
        YTReady = true;
        YTLoading = false;
        onYouTubeIframeAPIReadyCallbacks.splice(0).forEach(cb => cb());
      };
    }
    function whenYTReady(cb) {
      if (YTReady && window.YT && window.YT.Player) cb();
      else onYouTubeIframeAPIReadyCallbacks.push(cb);
    }

    function createPlayer(videoId, start, useNoCookie, autoplay = true, muted = true) {
      frame.src = buildEmbedUrl(videoId, start, useNoCookie, autoplay, muted);
      loadYouTubeAPI();
      return new Promise((resolve, reject) => {
        whenYTReady(() => {
          try {
            player = new YT.Player('videoFrame', {
              events: {
                'onReady': (e) => {
                  try {
                    if (muted && e.target.mute) e.target.mute();
                    if (start && e.target.seekTo) {
                      const s = parseInt(String(start).replace('s',''), 10);
                      if (!Number.isNaN(s)) e.target.seekTo(s, true);
                    }
                    if (autoplay) {
                      const st = e.target.playVideo && e.target.playVideo();
                      if (st && typeof st.then === 'function') {
                        st.then(() => resolve('played')).catch(err => reject(err));
                      } else {
                        setTimeout(() => resolve('played'), 300);
                      }
                    } else {
                      resolve('ready');
                    }
                  } catch(err) {
                    reject(err);
                  }
                },
                'onError': (ev) => {
                  reject(new Error('YT Player Error: ' + (ev && ev.data)));
                },
              }
            });
          } catch (err) {
            reject(err);
          }
        });
      });
    }

    async function tryPlaySequence(options) {
      const { id, start, originalUrl } = options || {};
      lastVideoId = id;
      lastStart = start;
      lastOriginalUrl = originalUrl;

      openOverlay();

      try {
        useNoCookieGlobal = false;
        await createPlayer(id, start, false, true, true);
        return;
      } catch (e1) {
        try {
          useNoCookieGlobal = true;
          await createPlayer(id, start, true, true, true);
          return;
        } catch (e2) {
          closeOverlay();
          showError(originalUrl || (id ? `https://www.youtube.com/watch?v=${id}` : '#'));
        }
      }
    }

    document.addEventListener('click', (e) => {
      const t = e.target.closest('.video-thumb');
      if (t) {
        const raw = t.getAttribute('data-video-id');
        const id = extractVideoId(raw);
        const start = t.getAttribute('data-start') || null;
        tryPlaySequence({ id, start, originalUrl: raw });
      }
    });

    btnClose && btnClose.addEventListener('click', closeOverlay);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && overlay.classList.contains('active')) closeOverlay();
    });
  </script>
</body>
</html>